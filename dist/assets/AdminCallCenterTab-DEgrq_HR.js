import{r as n,o as U,p as t,j as e,L as k,H,U as N,G as E,z as v,C as O,P as I,m as M,E as X,t as V,q as T}from"./index-DUPWpW8A.js";import{C as W}from"./circle-alert-B0IzNjX-.js";import{R as J}from"./refresh-cw-BkgYHOZ_.js";import{U as K}from"./AdminDashboard-BU0UmRvC.js";import{C as Z}from"./circle-check-Qk3G_yr2.js";import{A as L}from"./activity-BG5XCvRc.js";import"./tag-BGbJZdn1.js";import"./wallet-BFwfCN9s.js";import"./credit-card-DAN-H1xb.js";import"./eye-CBi2j-I1.js";import"./star-2C2GV9n2.js";import"./log-out-Dbf8rVC2.js";import"./file-text-C13QLo35.js";import"./calendar-BMCDamkU.js";import"./dollar-sign-BCZLu3ly.js";import"./circle-check-big-XQGMyZIM.js";import"./StatusBadge--u-qgK0F.js";import"./shield-Ct1SRrqB.js";import"./user-plus-8xsMQ1w_.js";import"./square-pen-BPJTNJbf.js";import"./trash-2-DbhZTeJ9.js";import"./mail-BRU6kRbt.js";const x=({label:s,value:d,icon:l,color:m,subtext:o})=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-100 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:`w-10 h-10 ${m} rounded-lg flex items-center justify-center`,children:e.jsx(l,{size:20,className:"text-white"})}),e.jsx("span",{className:"text-2xl font-bold text-gray-900",children:d})]}),e.jsx("p",{className:"text-sm text-gray-600",children:s}),o&&e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:o})]}),ee=({status:s})=>{const d={online:{color:"bg-green-100 text-green-700",label:"Ã‡evrimiÃ§i"},busy:{color:"bg-red-100 text-red-700",label:"MeÅŸgul"},away:{color:"bg-yellow-100 text-yellow-700",label:"Uzakta"},offline:{color:"bg-gray-100 text-gray-500",label:"Ã‡evrimdÄ±ÅŸÄ±"}},{color:l,label:m}=d[s];return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${l}`,children:m})},ae=({status:s})=>{const d={waiting:{color:"bg-yellow-100 text-yellow-700",label:"Bekliyor"},ringing:{color:"bg-blue-100 text-blue-700",label:"Ã‡alÄ±yor"},answered:{color:"bg-green-100 text-green-700",label:"GÃ¶rÃ¼ÅŸmede"},completed:{color:"bg-gray-100 text-gray-600",label:"TamamlandÄ±"},abandoned:{color:"bg-red-100 text-red-700",label:"Ä°ptal"},missed:{color:"bg-orange-100 text-orange-700",label:"CevapsÄ±z"}},{color:l,label:m}=d[s];return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${l}`,children:m})},z=s=>{const d=Math.floor(s/60),l=s%60;return`${d}:${l.toString().padStart(2,"0")}`},se=s=>new Date(s).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"}),Se=()=>{const[s,d]=n.useState(null),[l,m]=n.useState(null),[o,w]=n.useState(null),[u,f]=n.useState([]),[p,_]=n.useState([]),[R,P]=n.useState([]),[D,C]=n.useState(!0),[b,h]=n.useState(null),[S,A]=n.useState(!1),{answerCallById:G,rejectCallById:q}=U();n.useEffect(()=>{const a=localStorage.getItem("yolmov_admin");if(a)try{const r=JSON.parse(a);d(r)}catch(r){console.error("Failed to parse admin data:",r)}},[]);const g=n.useCallback(async()=>{try{C(!0);const[a,r,c,i]=await Promise.all([t.getCallCenterStats(),t.getCallAgents(),t.getActiveCalls(),t.getCallQueues()]);w(a),f(r),_(c),P(i)}catch(a){console.error("Load error:",a),h("Veriler yÃ¼klenirken hata oluÅŸtu")}finally{C(!1)}},[]);n.useEffect(()=>{if(s&&u.length>0){const a=u.find(r=>r.admin_id===s.id);m(a||null)}},[s,u]),n.useEffect(()=>{g();const a=t.subscribeToQueueChanges(i=>{if(console.log("ðŸ“ž [AdminCallCenter] New queue assignment:",i),s&&i.assigned_agent_id&&[...document.querySelectorAll("[data-agent-admin-id]")].find(y=>y.getAttribute("data-agent-admin-id")===s.id)&&i.status==="ringing"){try{new Audio("/notification.mp3").play().catch(Y=>console.log("Audio play failed:",Y))}catch(y){console.log("Audio not supported:",y)}"Notification"in window&&Notification.permission==="granted"&&new Notification("Yeni Ã‡aÄŸrÄ± Geliyor!",{body:`${i.caller_name||"Bilinmeyen"} sizi arÄ±yor`,icon:"/icons/icon-192.png",tag:i.call_id||i.id})}t.getActiveCalls().then(_),t.getCallCenterStats().then(w)}),r=t.subscribeToAgentChanges(i=>{t.getCallAgents().then(f)});"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission();const c=setInterval(()=>{g()},3e4);return()=>{a(),r(),clearInterval(c)}},[g,s]);const B=async()=>{if(s){A(!0),h(null);try{if(!l&&!await t.registerAsAgent(s.id,s.name))throw new Error("Agent kaydÄ± oluÅŸturulamadÄ±. LÃ¼tfen migration 028_fix_call_agents_rls.sql dosyasÄ±nÄ± Supabase'de Ã§alÄ±ÅŸtÄ±rÄ±n.");const a=(l==null?void 0:l.status)==="online"?"offline":"online";if(!await t.updateAgentStatus(s.id,a))throw new Error("Agent durumu gÃ¼ncellenemedi. LÃ¼tfen migration 028_fix_call_agents_rls.sql dosyasÄ±nÄ± Supabase'de Ã§alÄ±ÅŸtÄ±rÄ±n.");const c=await t.getCallAgents();f(c);const i=c.find(j=>j.admin_id===s.id);m(i||null),console.log(`âœ… Agent status: ${a}`)}catch(a){console.error("âŒ Toggle status error:",a),h(a.message||"Durum deÄŸiÅŸtirilemedi. LÃ¼tfen daha sonra tekrar deneyin.")}finally{A(!1)}}},Q=async a=>{if(!(!a.call_id||!s))try{if(a.status==="waiting"||!a.assigned_agent_id){l||await t.registerAsAgent(s.id,s.name);const c=(await t.getCallAgents()).find(i=>i.admin_id===s.id);c&&(await T.from("call_queue_assignments").update({assigned_agent_id:c.id,assigned_at:new Date().toISOString(),status:"ringing",updated_at:new Date().toISOString()}).eq("id",a.id),await T.from("calls").update({receiver_id:s.id,status:"ringing"}).eq("id",a.call_id))}await t.updateQueueAssignmentStatus(a.id,"answered"),await G(a.call_id),s&&await t.setAgentCurrentCall(s.id,a.call_id),g()}catch(r){console.error("Answer call error:",r)}},$=async a=>{if(a.call_id)try{await t.updateQueueAssignmentStatus(a.id,"missed"),await q(a.call_id),g()}catch(r){console.error("Reject call error:",r)}},F=async a=>{if(a.call_id)try{await t.endCall(a.call_id)?(await t.updateQueueAssignmentStatus(a.id,"completed"),s&&await t.setAgentCurrentCall(s.id,null),g()):h("Ã‡aÄŸrÄ± sonlandÄ±rÄ±lamadÄ±. LÃ¼tfen tekrar deneyin.")}catch(r){console.error("âŒ End call error:",r),h("Ã‡aÄŸrÄ± sonlandÄ±rÄ±lÄ±rken hata oluÅŸtu.")}};return D&&!o?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(k,{className:"w-8 h-8 text-brand-orange animate-spin"})}):e.jsxs("div",{className:"space-y-6",children:[b&&b.includes("migration")&&e.jsx("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(W,{className:"w-5 h-5 text-yellow-600 shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-bold text-yellow-800",children:"VeritabanÄ± Migrasyonu Gerekli"}),e.jsx("p",{className:"text-sm text-yellow-700 mt-1",children:b}),e.jsxs("details",{className:"mt-2",children:[e.jsx("summary",{className:"text-xs font-medium text-yellow-800 cursor-pointer hover:underline",children:"Migration SQL'i gÃ¶ster"}),e.jsx("pre",{className:"mt-2 p-3 bg-yellow-100 rounded text-xs overflow-x-auto",children:`-- Supabase SQL Editor'da Ã§alÄ±ÅŸtÄ±rÄ±n:
DROP POLICY IF EXISTS "call_agents_select_all" ON call_agents;
CREATE POLICY "call_agents_select_all" ON call_agents FOR SELECT USING (true);

DROP POLICY IF EXISTS "call_agents_insert_admin" ON call_agents;
CREATE POLICY "call_agents_insert_admin" ON call_agents FOR INSERT 
WITH CHECK (admin_id = auth.uid() OR auth.role() = 'service_role');

DROP POLICY IF EXISTS "call_agents_update_admin" ON call_agents;
CREATE POLICY "call_agents_update_admin" ON call_agents FOR UPDATE 
USING (admin_id = auth.uid() OR auth.role() = 'service_role');`})]})]})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(H,{className:"text-brand-orange"}),"Ã‡aÄŸrÄ± Merkezi"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Gelen Ã§aÄŸrÄ±larÄ± yÃ¶netin ve mÃ¼ÅŸterilere destek saÄŸlayÄ±n"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:g,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",title:"Yenile",children:e.jsx(J,{size:18,className:"text-gray-500"})}),e.jsx("button",{onClick:B,disabled:S,className:`flex items-center gap-2 px-4 py-2 rounded-xl font-medium transition-all ${(l==null?void 0:l.status)==="online"?"bg-green-100 text-green-700 hover:bg-green-200":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:S?e.jsx(k,{size:16,className:"animate-spin"}):(l==null?void 0:l.status)==="online"?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"Ã‡evrimiÃ§i"]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"w-2 h-2 bg-gray-400 rounded-full"}),"Ã‡evrimdÄ±ÅŸÄ±"]})})]})]}),o&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4",children:[e.jsx(x,{label:"Toplam Agent",value:o.totalAgents,icon:N,color:"bg-slate-500"}),e.jsx(x,{label:"Ã‡evrimiÃ§i",value:o.onlineAgents,icon:K,color:"bg-green-500"}),e.jsx(x,{label:"Bekleyen",value:o.waitingCalls,icon:E,color:"bg-yellow-500"}),e.jsx(x,{label:"Aktif GÃ¶rÃ¼ÅŸme",value:o.activeCalls,icon:v,color:"bg-blue-500"}),e.jsx(x,{label:"BugÃ¼n Tamamlanan",value:o.todayCompleted,icon:Z,color:"bg-emerald-500"}),e.jsx(x,{label:"Ort. Bekleme",value:z(o.avgWaitTime),icon:O,color:"bg-orange-500"}),e.jsx(x,{label:"Ort. GÃ¶rÃ¼ÅŸme",value:z(o.avgTalkTime),icon:L,color:"bg-purple-500"})]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2 space-y-4",children:e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-100 flex items-center justify-between",children:e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(E,{size:18,className:"text-brand-orange"}),"Aktif Ã‡aÄŸrÄ±lar",p.length>0&&e.jsx("span",{className:"px-2 py-0.5 bg-orange-100 text-orange-600 text-xs rounded-full",children:p.length})]})}),e.jsx("div",{className:"divide-y divide-gray-50",children:p.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx(I,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500",children:"Åžu an aktif Ã§aÄŸrÄ± yok"}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Yeni Ã§aÄŸrÄ±lar burada gÃ¶rÃ¼necek"})]}):p.map(a=>e.jsx(M.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-4 hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-gray-900",children:a.caller_name||"Anonim Arayan"}),e.jsx(ae,{status:a.status})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-500",children:[a.caller_phone&&e.jsx("span",{children:a.caller_phone}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(O,{size:12}),se(a.queued_at)]}),e.jsx("span",{className:"text-xs px-2 py-0.5 bg-gray-100 rounded",children:a.queue_name})]}),a.target_partner_id&&e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["â†’ Partner: ",a.partner_name||a.target_partner_id]}),a.caller_message&&e.jsxs("p",{className:"text-xs text-gray-400 mt-1 italic",children:['"',a.caller_message,'"']})]}),a.status==="waiting"||a.status==="ringing"?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Q(a),className:"p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors",title:"Cevapla",children:e.jsx(I,{size:18})}),e.jsx("button",{onClick:()=>$(a),className:"p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",title:"Reddet",children:e.jsx(X,{size:18})})]}):a.status==="answered"?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-600 mr-2",children:[e.jsx(v,{size:18,className:"animate-pulse"}),e.jsx("span",{className:"text-sm font-medium",children:"GÃ¶rÃ¼ÅŸmede"})]}),e.jsx("button",{onClick:()=>F(a),className:"p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",title:"Ã‡aÄŸrÄ±yÄ± SonlandÄ±r",children:e.jsx(V,{size:18})})]}):e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(v,{size:18,className:"animate-pulse"}),e.jsx("span",{className:"text-sm font-medium",children:"GÃ¶rÃ¼ÅŸmede"})]})]})},a.id))})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-100",children:e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(N,{size:18,className:"text-brand-orange"}),"Ajanlar"]})}),e.jsx("div",{className:"divide-y divide-gray-50 max-h-[400px] overflow-y-auto",children:u.length===0?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx(N,{className:"w-10 h-10 text-gray-300 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"HenÃ¼z agent yok"})]}):u.map(a=>e.jsxs("div",{className:`p-3 flex items-center justify-between ${a.admin_id===(s==null?void 0:s.id)?"bg-orange-50":""}`,children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900 text-sm",children:[a.display_name||a.admin_name,a.admin_id===(s==null?void 0:s.id)&&e.jsx("span",{className:"ml-1 text-xs text-orange-500",children:"(Sen)"})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["BugÃ¼n: ",a.calls_handled_today," Ã§aÄŸrÄ±"]})]}),e.jsx(ee,{status:a.status})]},a.id))})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-100",children:e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(L,{size:18,className:"text-brand-orange"}),"Ã‡aÄŸrÄ± HavuzlarÄ±"]})}),e.jsx("div",{className:"divide-y divide-gray-50",children:R.map(a=>e.jsx("div",{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900 text-sm",children:a.name}),e.jsx("p",{className:"text-xs text-gray-500",children:a.description})]}),e.jsx("span",{className:`w-2 h-2 rounded-full ${a.is_active?"bg-green-500":"bg-gray-300"}`})]})},a.id))})]})]})]})]})};export{Se as default};
