let c=null,m=0;const b=300*1e3;async function h(){const t=Date.now();if(c&&t-m<b)return console.log("ðŸ’° Using cached pricing config"),c;try{console.log("ðŸŒ Fetching pricing config from Supabase...");const{data:e,error:i}=await window.supabase.from("pricing_config").select("*").eq("is_active",!0).order("updated_at",{ascending:!1}).limit(1).single();if(i||!e)throw new Error("Pricing config not found");return c={id:e.id,baseFee:parseFloat(e.base_fee),shortDistanceLimit:e.short_distance_limit,mediumDistanceLimit:e.medium_distance_limit,shortDistanceRate:parseFloat(e.short_distance_rate),mediumDistanceRate:parseFloat(e.medium_distance_rate),longDistanceRate:parseFloat(e.long_distance_rate),nightMultiplier:parseFloat(e.night_multiplier),weekendMultiplier:parseFloat(e.weekend_multiplier),sedanMultiplier:parseFloat(e.sedan_multiplier),suvMultiplier:parseFloat(e.suv_multiplier),minibusMultiplier:parseFloat(e.minibus_multiplier),luxuryMultiplier:parseFloat(e.luxury_multiplier),brokenVehicleMultiplier:parseFloat(e.broken_vehicle_multiplier),ditchMultiplier:parseFloat(e.ditch_multiplier),accidentMultiplier:parseFloat(e.accident_multiplier),hasLoadMultiplier:parseFloat(e.has_load_multiplier),urgentMultiplier:parseFloat(e.urgent_multiplier),priceFlexibilityPercent:parseFloat(e.price_flexibility_percent),isActive:e.is_active,createdAt:e.created_at,updatedAt:e.updated_at,updatedBy:e.updated_by,notes:e.notes},m=t,c}catch(e){return console.error("âŒ Error fetching pricing config:",e),console.warn("âš ï¸ Using default fallback pricing config"),k()}}function k(){return{id:0,baseFee:800,shortDistanceLimit:15,mediumDistanceLimit:100,shortDistanceRate:0,mediumDistanceRate:25,longDistanceRate:15,nightMultiplier:1.15,weekendMultiplier:1.05,sedanMultiplier:1,suvMultiplier:1.1,minibusMultiplier:1.2,luxuryMultiplier:1.15,brokenVehicleMultiplier:1.1,ditchMultiplier:2,accidentMultiplier:1.2,hasLoadMultiplier:1.05,urgentMultiplier:1.2,priceFlexibilityPercent:100,isActive:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}async function D(t,e){const i=await h(),a=i.baseFee,r=g(t.distance,i),l=r.shortCharge+r.mediumCharge+r.longCharge,n=a+l,u=v(t,i),o=u.reduce((_,f)=>_*f.value,1),s=Math.round(n*o),d=Math.round(s*i.priceFlexibilityPercent/100),M=s-d,F=s+d,p={basePrice:a,distanceCharge:l,subtotal:n,totalMultiplier:parseFloat(o.toFixed(2)),finalPrice:s,minPrice:M,maxPrice:F,breakdown:{baseFee:a,distanceBreakdown:r,appliedMultipliers:u},calculatedAt:new Date().toISOString(),route:e};return console.log("ðŸ’° Price calculation complete:",p),p}function g(t,e){let i=t;const a=Math.min(i,e.shortDistanceLimit),r=a*e.shortDistanceRate;i-=a;const l=e.mediumDistanceLimit-e.shortDistanceLimit,n=Math.min(i,l),u=n*e.mediumDistanceRate;i-=n;const o=i,s=o*e.longDistanceRate;return{shortKm:parseFloat(a.toFixed(2)),mediumKm:parseFloat(n.toFixed(2)),longKm:parseFloat(o.toFixed(2)),shortCharge:Math.round(r),mediumCharge:Math.round(u),longCharge:Math.round(s)}}function v(t,e){const i=[];if(t.vehicleType==="sedan"?i.push({name:"Sedan",value:e.sedanMultiplier,reason:"Standart araÃ§ Ã§ekme"}):t.vehicleType==="suv"?i.push({name:"SUV/4x4",value:e.suvMultiplier,reason:"Daha aÄŸÄ±r araÃ§ (+%15)"}):t.vehicleType==="minibus"&&i.push({name:"MinibÃ¼s/Ticari",value:e.minibusMultiplier,reason:"BÃ¼yÃ¼k araÃ§ (+%30)"}),t.isLuxury&&i.push({name:"LÃ¼ks AraÃ§",value:e.luxuryMultiplier,reason:"Ã–zel ekipman gerekiyor (+%20)"}),t.vehicleCondition==="broken"?i.push({name:"ArÄ±zalÄ± AraÃ§",value:e.brokenVehicleMultiplier,reason:"Ek dikkat gerektiriyor (+%15)"}):t.vehicleCondition==="accident"?i.push({name:"Kaza Durumu",value:e.accidentMultiplier,reason:"Hasar tespiti gerekiyor (+%25)"}):t.vehicleCondition==="ditch"&&i.push({name:"Åžarampole DÃ¼ÅŸme",value:e.ditchMultiplier,reason:"Ã–zel kurtarma ekipmanÄ± (+%100)"}),t.hasLoad&&i.push({name:"YÃ¼k TaÅŸÄ±ma",value:e.hasLoadMultiplier,reason:"EÅŸya nakli hizmeti (+%10)"}),t.timing==="now"&&i.push({name:"Acil Hizmet",value:e.urgentMultiplier,reason:"Hemen mÃ¼dahale (+%30)"}),t.requestTime){const a=t.requestTime.getHours();(a>=22||a<6)&&i.push({name:"Gece Hizmeti",value:e.nightMultiplier,reason:"22:00-06:00 arasÄ± (+%25)"})}return t.isWeekend&&i.push({name:"Hafta Sonu",value:e.weekendMultiplier,reason:"Cumartesi/Pazar (+%10)"}),i}function y(t=new Date){const e=t.getDay();return e===0||e===6}function C(t=new Date){const e=t.getHours();return e>=22||e<6}async function w(t){const e=await h(),i=g(t,e),a=e.baseFee+i.shortCharge+i.mediumCharge+i.longCharge,r=Math.round(a*1.2),l=Math.round(r*e.priceFlexibilityPercent/100);return{min:r-l,max:r+l}}function x(){c=null,m=0,console.log("âœ… Pricing cache cleared")}export{y as a,x as b,D as c,h as g,C as i,w as q};
